/// ΔT (TT - UT1) 计算。
///
/// 移植自寿星万年历 (sxwnl) eph0.js 的 dt_calc / dt_T 部分。
/// 原作者：许剑伟
///
/// ΔT 是力学时 (Terrestrial Time, TT) 与世界时 (UT1) 之差，
/// 单位为秒。天文历算使用力学时，民用时间使用世界时。
///
/// 数据来源：
/// - 历史数据：多项式拟合（覆盖公元前4000年至2016年）
/// - 近现代数据：基于 DE440s 的预测拟合（2016-2050年）
library;

/// ΔT 分段多项式系数表。
///
/// 每 5 个元素为一组：[起始年, a0, a1, a2, a3]
/// ΔT(y) = a0 + a1*t + a2*t² + a3*t³
/// 其中 t = (y - 起始年) / (下一段起始年 - 起始年) * 10
///
/// 最后一组只有 2 个元素：[年份, ΔT值]，作为表尾标记。
final List<double> _dtAt = [
  // 历史数据
  -4000, 108371.7, -13036.80, 392.000, 0.0000,
  -500, 17201.0, -627.82, 16.170, -0.3413,
  -150, 12200.6, -346.41, 5.403, -0.1593,
  150, 9113.8, -328.13, -1.647, 0.0377,
  500, 5707.5, -391.41, 0.915, 0.3145,
  900, 2203.4, -283.45, 13.034, -0.1778,
  1300, 490.1, -57.35, 2.085, -0.0072,
  1600, 120.0, -9.81, -1.532, 0.1403,
  1700, 10.2, -0.91, 0.510, -0.0370,
  1800, 13.4, -0.72, 0.202, -0.0193,
  1830, 7.8, -1.81, 0.416, -0.0247,
  1860, 8.3, -0.13, -0.406, 0.0292,
  1880, -5.4, 0.32, -0.183, 0.0173,
  1900, -2.3, 2.06, 0.169, -0.0135,
  1920, 21.2, 1.69, -0.304, 0.0167,
  1940, 24.2, 1.22, -0.064, 0.0031,
  1960, 33.2, 0.51, 0.231, -0.0109,
  1980, 51.0, 1.29, -0.026, 0.0032,
  2000, 63.87, 0.1, 0, 0,
  2005, 64.7, 0.21, 0, 0,
  2012, 66.8, 0.22, 0, 0,
  // 基于 DE440s 的预测数据拟合
  2016, 68.1024, 0.5456, -0.0542, -0.001172,
  2020, 69.3612, 0.0422, -0.0502, 0.006216,
  2024, 69.1752, -0.0335, -0.0048, 0.000811,
  2028, 69.0206, -0.0275, 0.0055, -0.000014,
  2032, 68.9981, 0.0163, 0.0054, 0.000006,
  2036, 69.1498, 0.0599, 0.0053, 0.000026,
  2040, 69.4751, 0.1035, 0.0051, 0.000046,
  2044, 69.9737, 0.1469, 0.0050, 0.000066,
  2048, 70.6451, 0.1903, 0.0049, 0.000085,
  // 表尾标记
  2050, 71.0457,
];

/// 二次曲线外推（用于表格范围之外的年份）。
///
/// [jsd] 是加速度估计值（瑞士星历表 jsd=31）。
double _dtExt(double y, double jsd) {
  final dy = (y - 1820) / 100;
  return -20 + jsd * dy * dy;
}

/// 计算 ΔT = TT - UT1（单位：秒）。
///
/// [y] 为公历年份（可含小数，如 2024.5 表示年中）。
///
/// 原函数名：dt_calc(y)
double dtCalc(double y) {
  final d = _dtAt;

  // 表中最后一年及其 ΔT 值
  final y0 = d[d.length - 2];
  final t0 = d[d.length - 1];

  if (y >= y0) {
    // 表尾之后：用二次曲线外推，并平滑过渡
    const jsd = 31.0; // 加速度估计（瑞士星历表）
    if (y > y0 + 100) return _dtExt(y, jsd);
    final v = _dtExt(y, jsd);
    final dv = _dtExt(y0, jsd) - t0;
    return v - dv * (y0 + 100 - y) / 100;
  }

  // 查找所在分段
  int i;
  for (i = 0; i < d.length; i += 5) {
    if (y < d[i + 5]) break;
  }

  // 三次多项式插值
  final t1 = (y - d[i]) / (d[i + 5] - d[i]) * 10;
  final t2 = t1 * t1;
  final t3 = t2 * t1;
  return d[i + 1] + d[i + 2] * t1 + d[i + 3] * t2 + d[i + 4] * t3;
}

/// 计算 ΔT = TT - UT1（单位：天）。
///
/// [t] 为 J2000.0 起算的儒略日数。
///
/// 原函数名：dt_T(t)
double dtT(double t) {
  return dtCalc(t / 365.2425 + 2000) / 86400.0;
}
